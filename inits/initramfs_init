#!/bin/busybox sh

/bin/busybox --install -s /bin

mkdir -p /dev
mkdir -p /proc
mkdir -p /sys
mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs none /dev


CONSOLE=console
export CONSOLE

rootfs_uuid=$(cat rootfs_uuid)
echo "Rootfs UUID=$rootfs_uuid" > /dev/$CONSOLE
while [ "$(blkid | grep UUID=\"$rootfs_uuid\")" = "" ]; do
    echo "Waiting for rootfs to appear in /dev..." > /dev/$CONSOLE;
    sleep 1;
done

mkdir /mnt
echo "Attempting to mount rootfs..." > /dev/$CONSOLE;
if ! mount -a; then
    echo "Mounting rootfs failed! Spawning shell" > /dev/$CONSOLE;
    exec setsid sh -c 'exec sh </dev/$CONSOLE >/dev/$CONSOLE 2>&1'
fi

cd /mnt
echo "Executing /mnt/init" > /dev/$CONSOLE

exec setsid sh -c 'exec sh /mnt/init </dev/$CONSOLE >/dev/$CONSOLE 2>&1'

exit

